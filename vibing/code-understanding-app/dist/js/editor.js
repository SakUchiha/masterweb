document.addEventListener("DOMContentLoaded",function(){window.CONFIG||(window.CONFIG=window.CONFIG||{});const e=!!window.uiManager,n=!!window.apiService,t=document.getElementById("code"),o=document.getElementById("output");if("localhost"===window.location.hostname||window.location.hostname,!t||!o)return;let i=!1,a=!1,r=null,s=0;const c='<!DOCTYPE html>\n    <html>\n    <head>\n        <title>My Web Page</title>\n        <style>\n            body {\n                font-family: Arial, sans-serif;\n                margin: 20px;\n                line-height: 1.6;\n            }\n            .container {\n                max-width: 800px;\n                margin: 0 auto;\n            }\n            h1 {\n                color: #2c3e50;\n            }\n        </style>\n    </head>\n    <body>\n        <div class="container">\n            <h1>Welcome to the Code Editor</h1>\n            <p>Start coding here!</p>\n        </div>\n    </body>\n    </html>';function l(){if(i)return;const e=Date.now();if(!(e-s<500)){s=e,i=!0;try{o.classList.add("loading");const e=t.value;o.sandbox="allow-scripts allow-same-origin allow-forms allow-popups";const n=`\n        <!DOCTYPE html>\n        <html>\n          <head>\n            ${"\n        <meta http-equiv=\"Content-Security-Policy\" \n              content=\"default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;\n                      style-src 'self' 'unsafe-inline' https:;\n                      img-src 'self' data: https:;\n                      connect-src 'self' http: https:;\">"}\n            <base target="_blank">\n            <style>\n              /* Default styles for preview */\n              body {\n                margin: 0;\n                padding: 20px;\n                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n                line-height: 1.6;\n              }\n              /* Error display styling */\n              .error-display {\n                background: #fee;\n                color: #e74c3c;\n                padding: 10px;\n                border-radius: 4px;\n                border-left: 4px solid #e74c3c;\n                margin: 10px 0;\n                font-family: monospace;\n                white-space: pre-wrap;\n              }\n            </style>\n          </head>\n          <body>\n            <script>\n              window.onerror = function(msg, url, line, col, error) {\n                const errorDiv = document.createElement('div');\n                errorDiv.className = 'error-display';\n                errorDiv.textContent = \`Error: \${msg}\\nLine: \${line}\\nColumn: \${col}\`;\n                document.body.insertBefore(errorDiv, document.body.firstChild);\n                return false;\n              };\n            <\/script>\n            ${e.replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"\x3c!-- Script removed for security --\x3e").replace(/javascript:/gi,"#").replace(/on\w+\s*=/gi,"data-disabled=")}\n          </body>\n        </html>\n      `,a=new Blob([n],{type:"text/html"}),r=URL.createObjectURL(a);o.src=r,o.onload=()=>{URL.revokeObjectURL(r),o.classList.remove("loading"),i=!1,s&&clearTimeout(s)},o.onerror=e=>{o.classList.remove("loading"),o.srcdoc=`\n          <html><body style="margin:0;padding:20px;font-family:sans-serif;">\n            <div style="background:#fee;color:#e74c3c;padding:15px;border-radius:4px;border-left:4px solid #e74c3c;">\n              <h3 style="margin:0 0 10px 0">Error loading preview</h3>\n              <p style="margin:0">Please check your code for errors.</p>\n              ${e?`<pre style="margin:10px 0 0 0;font-size:14px">${e.toString()}</pre>`:""}\n            </div>\n          </body></html>\n        `,i=!1};const s=setTimeout(()=>{i&&(o.classList.remove("loading"),o.srcdoc='\n            <html><body style="margin:0;padding:20px;font-family:sans-serif;">\n              <div style="background:#fff3cd;color:#856404;padding:15px;border-radius:4px;border-left:4px solid #856404;">\n                <h3 style="margin:0 0 10px 0">Execution Timeout</h3>\n                <p style="margin:0">Your code took too long to execute. This might be due to an infinite loop or heavy computation.</p>\n              </div>\n            </body></html>\n          ',i=!1)},1e4)}catch(e){o.classList.remove("loading"),runTimeout&&clearTimeout(runTimeout),o.srcdoc=`\n        <html><body style="margin:0;padding:20px;font-family:sans-serif;">\n          <div style="background:#fee;color:#e74c3c;padding:15px;border-radius:4px;border-left:4px solid #e74c3c;">\n            <h3 style="margin:0 0 10px 0">Error running code</h3>\n            <p style="margin:0 0 10px 0">There was a problem executing your code. Please check for syntax errors.</p>\n            <pre style="margin:0;font-size:14px">${e.toString()}</pre>\n          </div>\n        </body></html>\n      `,i=!1}}}const d=document.getElementById("run"),m=document.getElementById("clear"),u=document.getElementById("save"),p=document.getElementById("autoRunToggle");d&&d.addEventListener("click",l),m&&m.addEventListener("click",function(){t.value="",o.srcdoc=""}),u&&u.addEventListener("click",function(){const e=t.value,n=new Blob([e],{type:"text/html"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download="code.html",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}),p&&p.addEventListener("click",function(){a=!a;const e=document.getElementById("autoRunToggle");if(e){a=!a,e.classList.toggle("active",a);const n=e.querySelector("i"),t=Array.from(e.childNodes).find(e=>e.nodeType===Node.TEXT_NODE&&""!==e.textContent.trim());if(t)t.textContent=a?" Auto Run: ON":" Auto Run: OFF";else{const n=document.createElement("span");n.textContent=a?" Auto Run: ON":" Auto Run: OFF",e.appendChild(n)}n&&(a?(n.className="fas fa-sync-alt fa-spin",l()):(n.className="fas fa-sync-alt",r&&(clearTimeout(r),r=null)))}}),t&&t.addEventListener("input",function(){a&&r&&clearTimeout(r),a&&(r=setTimeout(()=>{l()},1e3))});const g=new URLSearchParams(window.location.search).get("lesson")||localStorage.getItem("lesson");if(g){if(e)try{uiManager.showLoading("code","Loading lesson...")}catch(e){}if(n)apiService.get(`/api/lessons/${g}`).then(n=>{if(e)try{uiManager.hideLoading("code")}catch(e){}if(t.value=n&&n.exercise&&n.exercise.starter?n.exercise.starter:c,"localhost"===window.location.hostname||window.location.hostname,e)try{uiManager.showSuccess("Lesson loaded successfully!")}catch(e){}}).catch(n=>{if(e)try{uiManager.hideLoading("code")}catch(e){}if(e&&CONFIG&&CONFIG.MESSAGES&&CONFIG.MESSAGES.LESSON_LOAD_ERROR)try{uiManager.showError(CONFIG.MESSAGES.LESSON_LOAD_ERROR)}catch(e){}t.value=c,"localhost"===window.location.hostname||window.location.hostname});else{if(e)try{uiManager.hideLoading("code")}catch(e){}t.value=c}}else t.value=c,"localhost"===window.location.hostname||window.location.hostname;a||setTimeout(l,100)});