const express = require('express');
const router = express.Router();

// Mock Groq API responses for development
const MOCK_RESPONSES = {
  health: { status: 'healthy', message: 'Groq API is available' },
  explain: {
    response: "This is a mock explanation. In production, this would be generated by Groq AI.",
    explanation: "Mock AI response for code explanation."
  },
  chat: {
    response: "Hello! I'm a mock AI assistant. The real Groq AI would provide intelligent responses here.",
    choices: [{
      message: {
        content: "Mock AI response for chat functionality."
      }
    }]
  }
};

// GET /api/groq/health - Health check
router.get('/health', (req, res) => {
  res.json(MOCK_RESPONSES.health);
});

// POST /api/groq - Main Groq API endpoint
router.post('/', async (req, res) => {
  try {
    const { messages, code, language, model, responseStyle } = req.body;

    // Check if Groq API key is configured
    const groqApiKey = process.env.GROQ_API_KEY;

    if (!groqApiKey || groqApiKey === 'your_groq_api_key_here') {
      // Return mock response if no API key
      let mockResponse;

      if (code && language) {
        // Code explanation request
        mockResponse = {
          response: `Mock AI Explanation for ${language.toUpperCase()} code:\n\n${code}\n\nThis is a placeholder response. Configure GROQ_API_KEY in your .env file to get real AI responses.`,
          explanation: `Mock explanation for ${language} code.`
        };
      } else if (messages) {
        // Chat request
        mockResponse = {
          response: "Mock AI Response: Configure GROQ_API_KEY to enable real AI chat functionality.",
          choices: [{
            message: {
              content: "Mock AI chat response. Add your Groq API key to get intelligent responses."
            }
          }]
        };
      } else {
        mockResponse = {
          response: "Mock AI Response: No API key configured.",
          error: "GROQ_API_KEY not configured"
        };
      }

      return res.json(mockResponse);
    }

    // Real Groq API integration would go here
    // For now, return enhanced mock responses
    let response;

    if (code && language) {
      // Code explanation
      response = {
        response: `AI Analysis for ${language.toUpperCase()}:\n\n${code}\n\n**Key Points:**\nâ€¢ This code demonstrates ${language} syntax\nâ€¢ Best practices are followed\nâ€¢ Consider error handling for production use\n\n**Suggestions:**\nâ€¢ Add comments for clarity\nâ€¢ Consider performance optimizations\nâ€¢ Test edge cases thoroughly`,
        explanation: `Professional code analysis for ${language} code.`
      };
    } else if (messages && messages.length > 0) {
      // Chat interaction
      const userMessage = messages[messages.length - 1]?.content || '';

      if (userMessage.toLowerCase().includes('html')) {
        response = {
          response: "**HTML Best Practices Guide**\n\n**Semantic HTML:**\nâ€¢ Use `<header>`, `<nav>`, `<main>`, `<section>`, `<article>`, `<aside>`, `<footer>`\nâ€¢ Choose semantic elements over generic `<div>`\n\n**Accessibility:**\nâ€¢ Add `alt` attributes to images\nâ€¢ Use proper heading hierarchy (h1â†’h2â†’h3)\nâ€¢ Ensure sufficient color contrast\n\n**Performance:**\nâ€¢ Minimize DOM depth\nâ€¢ Use CSS for styling, not inline styles\nâ€¢ Optimize images and media\n\n**What specific HTML topic would you like to explore?** ðŸŽ¯",
          choices: [{
            message: {
              content: "**HTML Best Practices Guide**\n\n**Semantic HTML:**\nâ€¢ Use `<header>`, `<nav>`, `<main>`, `<section>`, `<article>`, `<aside>`, `<footer>`\nâ€¢ Choose semantic elements over generic `<div>`\n\n**Accessibility:**\nâ€¢ Add `alt` attributes to images\nâ€¢ Use proper heading hierarchy (h1â†’h2â†’h3)\nâ€¢ Ensure sufficient color contrast\n\n**Performance:**\nâ€¢ Minimize DOM depth\nâ€¢ Use CSS for styling, not inline styles\nâ€¢ Optimize images and media\n\n**What specific HTML topic would you like to explore?** ðŸŽ¯"
            }
          }]
        };
      } else if (userMessage.toLowerCase().includes('css')) {
        response = {
          response: "**CSS Mastery Guide**\n\n**Layout Systems:**\nâ€¢ **Flexbox**: Perfect for 1D layouts (rows/columns)\nâ€¢ **Grid**: Powerful for 2D layouts\nâ€¢ **Floats**: Legacy, avoid for new projects\n\n**Responsive Design:**\nâ€¢ Mobile-first approach\nâ€¢ Use `rem`/`em` for scalable typography\nâ€¢ Media queries for breakpoints\n\n**Modern CSS:**\nâ€¢ CSS Variables for theming\nâ€¢ CSS Grid for complex layouts\nâ€¢ Flexbox for component alignment\n\n**Performance Tips:**\nâ€¢ Minimize repaints/reflows\nâ€¢ Use `transform` for animations\nâ€¢ Optimize selectors\n\n**Which CSS concept interests you most?** ðŸŽ¨",
          choices: [{
            message: {
              content: "**CSS Mastery Guide**\n\n**Layout Systems:**\nâ€¢ **Flexbox**: Perfect for 1D layouts (rows/columns)\nâ€¢ **Grid**: Powerful for 2D layouts\nâ€¢ **Floats**: Legacy, avoid for new projects\n\n**Responsive Design:**\nâ€¢ Mobile-first approach\nâ€¢ Use `rem`/`em` for scalable typography\nâ€¢ Media queries for breakpoints\n\n**Modern CSS:**\nâ€¢ CSS Variables for theming\nâ€¢ CSS Grid for complex layouts\nâ€¢ Flexbox for component alignment\n\n**Performance Tips:**\nâ€¢ Minimize repaints/reflows\nâ€¢ Use `transform` for animations\nâ€¢ Optimize selectors\n\n**Which CSS concept interests you most?** ðŸŽ¨"
            }
          }]
        };
      } else if (userMessage.toLowerCase().includes('javascript') || userMessage.toLowerCase().includes('js')) {
        response = {
          response: "**JavaScript Development Guide**\n\n**Core Concepts:**\nâ€¢ **Variables**: `const`/`let` vs `var`\nâ€¢ **Functions**: Arrow functions, closures\nâ€¢ **Objects**: Prototypes, classes\nâ€¢ **Arrays**: Methods, iteration\n\n**Modern JavaScript:**\nâ€¢ **ES6+ Features**: Destructuring, spread/rest\nâ€¢ **Async/Await**: Clean async code\nâ€¢ **Modules**: Import/export system\nâ€¢ **Promises**: Async programming\n\n**Best Practices:**\nâ€¢ Use `const` by default\nâ€¢ Prefer arrow functions\nâ€¢ Handle errors properly\nâ€¢ Write clean, readable code\n\n**Debugging Tips:**\nâ€¢ Use browser dev tools\nâ€¢ Console.log strategically\nâ€¢ Learn debugging techniques\n\n**What JavaScript topic shall we explore?** âš¡",
          choices: [{
            message: {
              content: "**JavaScript Development Guide**\n\n**Core Concepts:**\nâ€¢ **Variables**: `const`/`let` vs `var`\nâ€¢ **Functions**: Arrow functions, closures\nâ€¢ **Objects**: Prototypes, classes\nâ€¢ **Arrays**: Methods, iteration\n\n**Modern JavaScript:**\nâ€¢ **ES6+ Features**: Destructuring, spread/rest\nâ€¢ **Async/Await**: Clean async code\nâ€¢ **Modules**: Import/export system\nâ€¢ **Promises**: Async programming\n\n**Best Practices:**\nâ€¢ Use `const` by default\nâ€¢ Prefer arrow functions\nâ€¢ Handle errors properly\nâ€¢ Write clean, readable code\n\n**Debugging Tips:**\nâ€¢ Use browser dev tools\nâ€¢ Console.log strategically\nâ€¢ Learn debugging techniques\n\n**What JavaScript topic shall we explore?** âš¡"
            }
          }]
        };
      } else {
        response = {
          response: "**Welcome to KidLearner AI Assistant! ðŸ¤–**\n\nI'm here to help you learn HTML, CSS, and JavaScript through interactive coding lessons. I can:\n\n**Code Help:**\nâ€¢ Explain code snippets\nâ€¢ Debug errors\nâ€¢ Suggest improvements\nâ€¢ Teach best practices\n\n**Learning Support:**\nâ€¢ Answer questions about web development\nâ€¢ Provide step-by-step tutorials\nâ€¢ Recommend learning resources\nâ€¢ Help with projects\n\n**Available Topics:**\nâ€¢ **HTML**: Structure and semantics\nâ€¢ **CSS**: Styling and layouts\nâ€¢ **JavaScript**: Interactivity and logic\n\n**What would you like to learn today?** Feel free to ask me anything about web development! ðŸš€",
          choices: [{
            message: {
              content: "**Welcome to KidLearner AI Assistant! ðŸ¤–**\n\nI'm here to help you learn HTML, CSS, and JavaScript through interactive coding lessons. I can:\n\n**Code Help:**\nâ€¢ Explain code snippets\nâ€¢ Debug errors\nâ€¢ Suggest improvements\nâ€¢ Teach best practices\n\n**Learning Support:**\nâ€¢ Answer questions about web development\nâ€¢ Provide step-by-step tutorials\nâ€¢ Recommend learning resources\nâ€¢ Help with projects\n\n**Available Topics:**\nâ€¢ **HTML**: Structure and semantics\nâ€¢ **CSS**: Styling and layouts\nâ€¢ **JavaScript**: Interactivity and logic\n\n**What would you like to learn today?** Feel free to ask me anything about web development! ðŸš€"
            }
          }]
        };
      }
    } else {
      response = {
        response: "**Welcome to KidLearner AI Assistant! ðŸ¤–**\n\nI'm here to help you learn HTML, CSS, and JavaScript through interactive coding lessons. I can:\n\n**Code Help:**\nâ€¢ Explain code snippets\nâ€¢ Debug errors\nâ€¢ Suggest improvements\nâ€¢ Teach best practices\n\n**Learning Support:**\nâ€¢ Answer questions about web development\nâ€¢ Provide step-by-step tutorials\nâ€¢ Recommend learning resources\nâ€¢ Help with projects\n\n**Available Topics:**\nâ€¢ **HTML**: Structure and semantics\nâ€¢ **CSS**: Styling and layouts\nâ€¢ **JavaScript**: Interactivity and logic\n\n**What would you like to learn today?** Feel free to ask me anything about web development! ðŸš€",
        choices: [{
          message: {
            content: "**Welcome to KidLearner AI Assistant! ðŸ¤–**\n\nI'm here to help you learn HTML, CSS, and JavaScript through interactive coding lessons. I can:\n\n**Code Help:**\nâ€¢ Explain code snippets\nâ€¢ Debug errors\nâ€¢ Suggest improvements\nâ€¢ Teach best practices\n\n**Learning Support:**\nâ€¢ Answer questions about web development\nâ€¢ Provide step-by-step tutorials\nâ€¢ Recommend learning resources\nâ€¢ Help with projects\n\n**Available Topics:**\nâ€¢ **HTML**: Structure and semantics\nâ€¢ **CSS**: Styling and layouts\nâ€¢ **JavaScript**: Interactivity and logic\n\n**What would you like to learn today?** Feel free to ask me anything about web development! ðŸš€"
          }
        }]
      };
    }

    res.json(response);

  } catch (error) {
    console.error('Groq API Error:', error);
    res.status(500).json({
      error: 'AI Service Error',
      message: 'Unable to process AI request',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

module.exports = router;